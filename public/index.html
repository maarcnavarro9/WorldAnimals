<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Animals of the world" />
    <meta name="author" content="Marc Navarro & Ángel Fernández" />
    <title>World Animals</title>
    <link href="./css/styles.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
</head>

<body>
    <header>
        <h1>World Animals</h1>
    </header>
    <main>
        <div class="videoMapContainer">
            <div class="videoContainer">
                <video id="myVideo" width="auto" height="auto" controls autoplay muted>
                    <source id="sourceMp4" src="/public/assets/videos/WorldAnimalsV1_4K.mp4" type="video/mp4">
                    <source id="sourceWebm" src="/public/assets/videos/WorldAnimalsV1_4K.webm" type="video/webm">
                    <track id="descTrackEn" kind="subtitles" label="English" srclang="en"
                        src="./media/descriptionsV1_En.vtt" />
                    <track id="descTrackEs" kind="subtitles" label="Spanish" srclang="es"
                        src="./media/descriptionsV1_Es.vtt" />
                    <track id="descTrackCa" kind="subtitles" label="Catalan" srclang="ca"
                        src="./media/descriptionsV1_Ca.vtt" />
                    <track id="metaTrack" kind="metadata" label="Metadata" src="./media/metadataV1.vtt" />
                </video>
            </div>
            <div class="buttonsContainer">
                <button id="btnVideo1">Video 1</button>
                <button id="btnVideo2">Video 2</button>
                <select id="qualitySelector">
                    <option value="4K" selected>4K</option>
                    <option value="FullHD">Full HD</option>
                    <option value="720p">720p</option>
                </select>
            </div>
            <div class="mapa" id="map">
                <script async defer
                    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-CwDTo2Lsq5qMAAV99Oa4u9slVjd7i2I&callback=initMap">
                    </script>
                <script>
                    let marcador;
                    let mapa;

                    async function initMap() {

                        // Ubicación inicial (Madrid como ejemplo)
                        const ubicacion = { lat: 40.416775, lng: -3.703790 };

                        // Creamos el mapa y lo centramos en la ubicación indicada
                        mapa = new google.maps.Map(document.getElementById('map'), {
                            zoom: 3,
                            center: ubicacion
                        });

                        // Agregamos un marcador inicial
                        marcador = new google.maps.Marker({
                            position: ubicacion,
                            map: mapa,
                            title: "Mi Ubicación"
                        });
                    }
                </script>
            </div>
        </div>
        <div class="descriptionContainer">
            <img id="fotoAnimal" src="./assets/img/portfolio/submarine.png" height="250px" width="100%" />
            <div class="card">
                <div class="nombresContainer">
                    <h2 id="nombre">Nombre animal</h2>
                    <h3 id="especie">Especie</h3>
                </div>
                <p id="descripcion">Descripción del animal</p>
            </div>
        </div>
        <div class="card" id="capitulos">
        </div>
    </main>

    <script src="./js/generarBotonesCapitulos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('myVideo');
            const qualitySelector = document.getElementById('qualitySelector');
            const btnVideo1 = document.getElementById('btnVideo1');
            const btnVideo2 = document.getElementById('btnVideo2');
            const sourceMp4 = document.getElementById('sourceMp4');
            const sourceWebm = document.getElementById('sourceWebm');
            const descTrackEn = document.getElementById('descTrackEn');
            const descTrackEs = document.getElementById('descTrackEs');
            const descTrackCa = document.getElementById('descTrackCa');
            const metaTrackElement = document.getElementById('metaTrack');

            // Se define un objeto que contiene las rutas de ambos videos en cada calidad.
            const videoSources = {
                "video1": {
                    "4K": {
                        mp4: "/public/assets/videos/WorldAnimalsV1_4K.mp4",
                        webm: "/public/assets/videos/WorldAnimalsV1_4K.webm",
                        subtitles: {
                            en: "./media/descriptionsV1_En.vtt",
                            es: "./media/descriptionsV1_Es.vtt",
                            ca: "./media/descriptionsV1_Ca.vtt",
                        },
                        metadata: "./media/metadataV1.vtt"
                    },
                    "FullHD": {
                        mp4: "/public/assets/videos/WorldAnimalsV1_1080p.mp4",
                        webm: "/public/assets/videos/WorldAnimalsV1_1080p.webm",
                        subtitles: {
                            en: "./media/descriptionsV1_En.vtt",
                            es: "./media/descriptionsV1_Es.vtt",
                            ca: "./media/descriptionsV1_Ca.vtt",
                        },
                        metadata: "./media/metadataV1.vtt"
                    },
                    "720p": {
                        mp4: "/public/assets/videos/WorldAnimalsV1_720p.mp4",
                        webm: "/public/assets/videos/WorldAnimalsV1_720p.webm",
                        subtitles: {
                            en: "./media/descriptionsV1_En.vtt",
                            es: "./media/descriptionsV1_Es.vtt",
                            ca: "./media/descriptionsV1_Ca.vtt",
                        },
                        metadata: "./media/metadataV1.vtt"
                    }
                },
                "video2": {
                    "4K": {
                        mp4: "/public/assets/videos/WorldAnimalsV2_4K.mp4",
                        webm: "/public/assets/videos/WorldAnimalsV2_4K.webm",
                        subtitles: {
                            en: "./media/descriptionsV2_En.vtt",
                            es: "./media/descriptionsV2_Es.vtt",
                            ca: "./media/descriptionsV2_Ca.vtt",
                        },
                        metadata: "./media/metadataV2.vtt"
                    },
                    "FullHD": {
                        mp4: "/public/assets/videos/WorldAnimalsV2_1080p.mp4",
                        webm: "/public/assets/videos/WorldAnimalsV2_1080p.webm",
                        subtitles: {
                            en: "./media/descriptionsV2_En.vtt",
                            es: "./media/descriptionsV2_Es.vtt",
                            ca: "./media/descriptionsV2_Ca.vtt",
                        },
                        metadata: "./media/metadataV2.vtt"
                    },
                    "720p": {
                        mp4: "/public/assets/videos/WorldAnimalsV2_720p.mp4",
                        webm: "/public/assets/videos/WorldAnimalsV2_720p.webm",
                        subtitles: {
                            en: "./media/descriptionsV2_En.vtt",
                            es: "./media/descriptionsV2_Es.vtt",
                            ca: "./media/descriptionsV2_Ca.vtt",
                        },
                        metadata: "./media/metadataV2.vtt"
                    }
                }
            };

            // Variable que almacena cuál video está activo. Por defecto, video1.
            let currentVideo = "video1";

            // Función para actualizar el video según el video actual y la calidad seleccionada.
            function updateVideo() {
                const quality = qualitySelector.value;
                const sources = videoSources[currentVideo][quality];
                if (sources) {
                    sourceMp4.src = sources.mp4;
                    sourceWebm.src = sources.webm;
                    descTrackEn.src = sources.subtitles.en;
                    descTrackEs.src = sources.subtitles.es;
                    descTrackCa.src = sources.subtitles.ca;
                    metaTrackElement.src = sources.metadata;
                    video.load();
                    video.play();
                }
            }

            // Cambia la calidad del video al seleccionar una opción
            qualitySelector.addEventListener('change', updateVideo);

            // Botón para seleccionar Video 1
            btnVideo1.addEventListener('click', () => {
                currentVideo = "video1";
                updateVideo();
            });

            // Botón para seleccionar Video 2
            btnVideo2.addEventListener('click', () => {
                currentVideo = "video2";
                updateVideo();
            });

            // Aseguramos que se muestren los subtítulos y se active el track de metadatos
            descTrackEn.track.mode = "disabled";
            descTrackEs.track.mode = "disabled";
            descTrackCa.track.mode = "disabled";

            const metaTrack = metaTrackElement.track;
            metaTrack.mode = "hidden";

            function obtenerTodasLasCues() {
                const cues = [];
                if (metaTrack && metaTrack.cues) {
                    // Accedemos a todas las cues de la pista
                    for (let i = 0; i < metaTrack.cues.length; i++) {
                        const cue = metaTrack.cues[i];
                        try {
                            // Almacenamos la cue en el array de cues
                            const metadata = JSON.parse(cue.text); // Asumimos que el contenido de la cue es JSON
                            cues.push(metadata); // Guardamos la metadata de cada cue
                        } catch (e) {
                            console.error('Error al parsear la metadata de la cue', e);
                        }
                    }
                }
                return cues;
            }

            metaTrackElement.addEventListener('load', () => {
                const todasLasCues = obtenerTodasLasCues();
                console.log(todasLasCues); // Muestra todas las cues en la consola
                // Puedes hacer algo con todas las cues, como generar botones
                generarBotonesCapitulos(todasLasCues);
            });

            // Evento para procesar metadatos y actualizar información en pantalla
            metaTrack.addEventListener('cuechange', () => {
                const activeCues = metaTrack.activeCues;
                if (activeCues.length > 0) {
                    try {
                        const metadata = JSON.parse(activeCues[0].text);

                        fotoAnimal.src = metadata.link_imagen || "./assets/img/portfolio/safe.png";

                        // Actualizamos texto
                        document.getElementById('nombre').textContent = metadata.Nombre || "Nombre";
                        document.getElementById('especie').textContent = metadata.Especie || "Especie";
                        document.getElementById('descripcion').textContent = metadata.Descripcion || "Descripción no disponible...";

                        // CAMBIO IMPORTANTE AQUÍ:
                        // Si en el metadata vienen coordenadas, las usamos para actualizar el mapa y el marcador
                        if (metadata.coordenadas_geográficas) {
                            const lat = parseFloat(metadata.coordenadas_geográficas.latitud);
                            const lng = parseFloat(metadata.coordenadas_geográficas.longitud);
                            if (!isNaN(lat) && !isNaN(lng)) {
                                mapa.setCenter({ lat, lng });
                                marcador.setPosition({ lat, lng });
                            }
                        }
                    } catch (e) {
                        console.error("Error al parsear metadata:", e);
                    }
                }
            });
        });
    </script>

</body>

</html>