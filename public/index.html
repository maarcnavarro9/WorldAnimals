<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Animals of the world" />
    <meta name="author" content="Marc Navarro & Ángel Fernández" />
    <title>World Animals</title>
    <link href="./css/styles.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="assets/gecko-svgrepo-com.svg" />
    <style>
        /* La lista de usuarios se oculta inicialmente */
        #activeUsers {
            display: none;
        }
    </style>
</head>

<body>
    <header>
        <h1>World Animals</h1>
    </header>
    <main>
        <div class="videoMapContainer">
            <div class="videoContainer">
                <video id="myVideo" width="auto" height="auto" controls autoplay muted>
                    <source id="sourceMp4" src="./assets/videos/WorldAnimalsV1_4K.mp4" type="video/mp4">
                    <source id="sourceWebm" src="./assets/videos/WorldAnimalsV1_4K.webm" type="video/webm">
                    <track id="descTrackEn" kind="subtitles" label="English" srclang="en"
                        src="./media/descriptionsV1_En.vtt" />
                    <track id="descTrackEs" kind="subtitles" label="Spanish" srclang="es"
                        src="./media/descriptionsV1_Es.vtt" />
                    <track id="descTrackCa" kind="subtitles" label="Catalan" srclang="ca"
                        src="./media/descriptionsV1_Ca.vtt" />
                    <track id="metaTrack" kind="metadata" label="Metadata" src="./media/metadataV1.vtt" />
                </video>
            </div>
            <div class="buttonsContainer">
                <button id="btnVideo1">Video 1</button>
                <button id="btnVideo2">Video 2</button>
                <select id="qualitySelector">
                    <option value="4K" selected>4K</option>
                    <option value="1080p">Full HD</option>
                    <option value="720p">720p</option>
                </select>
            </div>
            <div class="mapa" id="map">
            </div>
        </div>
        <div class="descriptionContainer">
            <img id="fotoAnimal" src="./assets/img/portfolio/submarine.png" height="250px" width="100%" />
            <div class="card">
                <div class="nombresContainer">
                    <h2 id="nombre">Nombre animal</h2>
                    <h3 id="especie">Especie</h3>
                </div>
                <p id="descripcion">Descripción del animal</p>
            </div>
        </div>
        <div class="card" id="capitulos">
        </div>
        <div>
            <!-- Formulario para asignar nombre de usuario -->
            <div>
                <input id="username" placeholder="Ingresa tu nombre de usuario" />
                <button id="setUsername">Establecer Nombre</button>
            </div>

            <!-- Botón para alternar la visibilidad de la lista de usuarios -->
            <div>
                <button id="toggleUsers">Usuarios</button>
                <button id="disconnectBtn">Salir</button>
            </div>

            <!-- Lista de usuarios activos -->
            <h3 id="usersTitle" style="display: none;">Usuarios Activos:</h3>
            <ul id="activeUsers" style="display: none;"></ul>

            <!-- Lista de mensajes -->
            <ul id="messages"></ul>

            <!-- Formulario de envío de mensajes -->
            <form id="form">
                <input id="input" autocomplete="off" placeholder="Escribe un mensaje..." />
                <button>Enviar</button>
            </form>
            <script src="/socket.io/socket.io.js">
            </script>
            <script>
                const socket = io();
                const messages = document.getElementById('messages');
                const form = document.getElementById('form');
                const input = document.getElementById('input');
                const usernameInput = document.getElementById('username');
                const setUsernameButton = document.getElementById('setUsername');
                const toggleUsersButton = document.getElementById('toggleUsers');
                const activeUsersList = document.getElementById('activeUsers');
                const usersTitle = document.getElementById('usersTitle');

                let username = null;

                // Establece el nombre de usuario
                setUsernameButton.addEventListener('click', () => {
                    if (usernameInput.value) {
                        username = usernameInput.value;
                        socket.emit('set username', username);
                    }
                });

                // Enviar mensaje solo si el usuario ha establecido su nombre
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    if (input.value && username) {
                        socket.emit('chat message', input.value);
                        input.value = '';
                    }
                });

                // Recibir y mostrar mensajes
                socket.on('chat message', function (msg) {
                    const item = document.createElement('li');
                    item.textContent = msg;
                    messages.appendChild(item);
                    window.scrollTo(0, document.body.scrollHeight);
                });

                socket.on('active users', function (users) {
                    activeUsersList.innerHTML = '';
                    users.forEach(function (user) {
                        const li = document.createElement('li');
                        li.textContent = user;
                        activeUsersList.appendChild(li);
                    });

                    // Si la lista estaba visible, asegurar que se muestre
                    const computedStyle = window.getComputedStyle(activeUsersList);
                    if (computedStyle.display !== 'none') {
                        activeUsersList.style.display = 'block';
                        usersTitle.style.display = 'block';
                    }
                });


                toggleUsersButton.addEventListener('click', () => {
                    // Solicita la lista actualizada al servidor
                    socket.emit('request active users');

                    // Forzar que la lista se muestre (sin alternar)
                    activeUsersList.style.display = 'block';
                    usersTitle.style.display = 'block';
                });


                document.getElementById('disconnectBtn').addEventListener('click', () => {
                    socket.disconnect();
                });

                // Forzar la desconexión cuando el usuario abandona la página
                window.addEventListener('beforeunload', () => {
                    socket.disconnect();
                });
            </script>
        </div>
    </main>
    <footer>
        <span>Marc Navarro Amengual y Ángel Fernández Rosado, 2025</span>
    </footer>

    <script src="./js/qualityVideoScreenSize.js"></script>
    <script src="./js/mapa.js"></script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-CwDTo2Lsq5qMAAV99Oa4u9slVjd7i2I&callback=initMap">
        </script>
    <script src="./js/generarBotonesCapitulos.js"></script>
    <script src="./js/script.js">
    </script>

</body>

</html>